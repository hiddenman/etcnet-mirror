#!/bin/bash

# This script is expected to automatically create the first interface
# configuration directories and files in case there are no existing ones
# in /etc/net/ifaces.

[ "$1" = "write" ] && TESTMODE=no
[ -x ${IP:=/sbin/ip} ] || exit 1
[ -x ${ETHTOOL:=/usr/sbin/ethtool} ] || exit 1
[ -d ${IFACEDIR:=/etc/net/ifaces} ] || exit 1
IFTAB=/etc/net/iftab

function store()
{
	local FILENAME=${1:?missing 1st arg to $FUNCNAME}
	local FILELINE=${2:?missing 2nd arg to $FUNCNAME}
	if [ "$TESTMODE" != "no" ]; then
		echo "TEST: will write to file $FILENAME:"
		echo '--------8<--------8<--------8<--------8<'
		echo -e "$FILELINE"
		echo '--------8<--------8<--------8<--------8<'
	else
		echo -e "$FILELINE" >> $FILENAME
	fi
}

function makedir()
{
	local DIRNAME=${1:?missing 1st arg to $FUNCNAME}
	if [ "$TESTMODE" != "no" ]; then
		echo "TEST: will create directory $DIRNAME:"
	else
		mkdir $DIRNAME
	fi
}

for iface in `$IP li | egrep '^[[:digit:]]+: ' | cut --delimiter=' ' --fields=2 | sed 's/://'`; do
	echo -n "Processing interface '$iface':"
	if [ -d $IFACEDIR/$iface ]; then
		echo " configuration exists"
		continue
	fi
	# pickup explicit ethernets only
	if [ "${iface//[0-9]*/}" = "eth" ]; then
		# find and use link-level address
		if $IP li sh dev $iface | fgrep -q 'link/ether'; then
			LLADDR=`$IP li sh dev $iface | fgrep 'link/ether' | sed 's/^ *link\/ether //' | cut --delimiter=' ' --fields=1`
			if [ "$LLADDR" != "00:00:00:00:00:00" ]; then
				store $IFTAB "# Generated by /etc/net initconf script\n$iface mac $LLADDR\n"
			fi
			makedir $IFACEDIR/$iface
			store $IFACEDIR/$iface/options "# If you want to change current interface name, edit $IFTAB,\n# rename current directory and uncomment this line:\n#TYPE=eth\n"
		fi
		# find module
		MODULE=`ethtool -i $iface | fgrep 'driver: ' | cut --delimiter=' ' --fields=2`
		if [ -n "$MODULE" ]; then
			store $IFACEDIR/$iface/options "# Uncomment this line if you don't have modules.conf alias for this interface\n# and don't intend to use hotplug configuration.\n#MODULE=$MODULE\n"
			store $IFTAB "# Generated by /etc/net initconf script\n#$iface driver $MODULE\n"
		fi
	fi
	# dump IPv4 info
	IPV4ADDRS=`$IP -4 ad sh dev $iface | grep '^    inet' | sed 's/^    inet //' | cut --delimiter=' ' --fields=1 | tr '\n' '\t' | sed 's/\t/ NEWLINE /g' | sed 's/ NEWLINE /\\\\n/g'`
	#echo "$IPV4ADDRS"
	[ -n "$IPV4ADDRS" ] && store $IFACEDIR/$iface/ipv4address $IPV4ADDRS
	IPV4ROUTES=`$IP -4 ro ls dev $iface type unicast scope global | tr '\n' '\t' | sed 's/\t/ NEWLINE /g' | sed 's/ NEWLINE /\\\\n/g'`
	[ -n "$IPV4ROUTES" ] && store $IFACEDIR/$iface/ipv4route "$IPV4ROUTES"
	echo ' finished'
done
